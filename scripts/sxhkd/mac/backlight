#! /bin/sh

if [ "$1" = "--help" ] || [ "$1" = "-h" ] || [ "$1" = "help" ]; then
  printf "$ backlight <command>
Interact with the backlight.

Commands:
  set <brightness>: set brightness
  get: get current brightness
  max: set the max brightness
  min: set the min brightness
  percent: set the brightness using percentages (+2, -5)

Example:
  $ backlight set 250 # set brightness to max
  $ backlight p +1 # increase brightness by 10%
"
  exit
fi

FILE=/sys/class/backlight/intel_backlight/brightness
# you might need to run
#   sudo chown $USER
# on the brightness file, otherwise you wont be able to write it,
# not even with sudo
MAX=$(cat /sys/class/backlight/intel_backlight/max_brightness) # 2777
MIN=40

set_brightness() {
  if [ -n "$1" ] && [ "$1" -gt -1 ] && [ "$1" -lt "$(($MAX+1))" ]; then
    echo $1 > $FILE
    echo $1
  else
    echo "Invalid number passed to set" 
    echo "It needs to be between 0 and $MAX"
  fi
}

get_brightness() {
  cat $FILE
}

percent() {
  if [ "$(echo $1 | cut -c 1)" = "+" ]; then
    PERCENTAGE=$(echo $1 | cut -d + -f 2)
    RES=$(echo "$(get_brightness)+(0.$PERCENTAGE*($MAX-5))" | bc | cut -d . -f 1)
    if [ "$RES" -lt -1 ]; then
      RES=0
    elif [ "$RES" -gt "$MAX" ]; then
      RES=$MAX
    fi
    set_brightness $RES
  elif [ "$(echo $1 | cut -c 1)" = "-" ]; then
    PERCENTAGE=$(echo $1 | cut -d - -f 2)
    RES=$(echo "$(get_brightness)-(0.$PERCENTAGE*($MAX-5))" | bc | awk '{printf "%f", $0}' | cut -d . -f 1)
    if [ "$RES" -lt -1 ] || [ "$RES" -eq -1 ] || [ "$RES" -eq -0 ]; then # weird edge cases, but I want display to go black
      RES=0
    elif [ "$RES" -gt "$MAX" ]; then
      RES=$MAX
    fi
    set_brightness $RES
  else
    echo "Invalid parameter passed to percent"
    echo "Please pass a number prefixed with '+' or '-'"
  fi
}

notification() {
  BRIGHTNESS_PERCENT=$(($(get_brightness)*100/MAX))
  HEAD="Brightness: $BRIGHTNESS_PERCENT"
  BODY="$(get-progress-string.sh 28 'â–ª' ' ' $BRIGHTNESS_PERCENT)"

  notify-send -i brightness -h string:x-canonical-private-synchronous:brightness -u normal -t 1000 "$HEAD" "$BODY"
}

case $1 in
  s|set) set_brightness $2; notification;;
  g|get) get_brightness;;
  max) set_brightness $MAX;;
  min) set_brightness $MIN;;
  p|perc|percent) notification; percent $2;;
  *) echo "Please pass a command. Pass 'help' for help.";;
esac


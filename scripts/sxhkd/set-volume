#! /bin/sh

XOB=/tmp/xobpipe

if [ "$1" = "--help" ] || [ "$1" = "-h" ] || [ "$1" = "help" ] || [ -z "$1" ]; then
  cat <<EOF
$ set-volume COMMAND
Set the volume and send a notification.

Commands:
  mute: toggle mute
  <n>%+: raise volume
  <n>%-: lower volume

Example:
  $ set-volume 5%+
  $ set-volume 5%-
  $ set-volume mute
EOF
  exit
fi

hash wpctl pactl || exit 127

COMMAND="$1"

notification() {
  WPCTL_OUT="$(LC_ALL=C wpctl get-volume @DEFAULT_AUDIO_SINK@ 2>/dev/null || true)"

  printf '%s\n' "$WPCTL_OUT" | grep -q '\[MUTED\]' && MUTE=1 || MUTE=0
  VOL="$(
      printf '%s\n' "$WPCTL_OUT" |
        awk '
          /Volume:/ {
            v=$2
            gsub(",", ".", v)
            if (v ~ /^[0-9.]+$/) {
              printf "%d\n", int(v*100 + 0.5)
              exit
            }
          }
        '
    )"

  [ -z "$VOL" ] && VOL=0
  echo mute: $MUTE, vol: $VOL

  IS_MUTE=""
  [ "$MUTE" -eq 1 ] && IS_MUTE=!

  if [ -p $XOB ]; then
    echo "$VOL$IS_MUTE"
    echo "$VOL$IS_MUTE" >$XOB
  fi
 }

case "$COMMAND" in
  mute) wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle 2>/dev/null;;
  *%+|*%-) wpctl set-volume @DEFAULT_AUDIO_SINK@ "${COMMAND}" 2>/dev/null;;
  *) echo Invalid command, see --help ;;
esac

notification

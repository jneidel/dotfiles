#! /bin/sh

. $HOME/.zsh/org.env
CALENDAR_FILE=$ORG_CALENDAR/main/project-deadlines.rem

if [ "$1" = "--help" ] || [ "$1" = "-h" ] || [ "$1" = "help" ]; then
  cat <<EOF
$ add-project-deadlines-to-calendar
Create calendar reminders for org project deadlines.
EOF
  exit
fi

add_a_task_for_missing_deadlines() {
  task_title="Add missing deadline for: $project_name"
  if ! task "$task_title" >/dev/null 2>&1; then
    task add "$task_title" prio:M >/dev/null
  fi
}

echo "# Don't edit by hand. This file has been autogenerated by 'add-project-deadlines-to-calendar'\n" >$CALENDAR_FILE

find $ORG_PROJECTS -maxdepth 2 -name 'index.norg' -or -name 'plan.norg' -or -name 'tasks.norg' | while read -r index_file; do
  project_name=`echo "$index_file" | cut -d/ -f6 | cut -d\  -f2-`
  deadline=`grep -Po "^deadline: \K.+" "$index_file"`
  if [ -z "$deadline" ]; then
    # add_a_task_for_missing_deadlines
    continue
  fi

  echo "$deadline SPECIAL COLOR 255 0 0 Û¹ $project_name" >>$CALENDAR_FILE
done
